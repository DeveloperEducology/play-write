import express from "express";
import cors from "cors";
import mongoose from "mongoose";
import dotenv from "dotenv";
import { GoogleGenerativeAI } from "@google/generative-ai";

// Import both scraper functions
import { scrapeUserTweets, scrapeSingleTweet } from "./scraper.js";

// Load environment variables
dotenv.config();

// --- Gemini AI Initialization ---
// Using a modern, efficient model
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const geminiModel = genAI.getGenerativeModel({
  model: "gemini-1.5-flash-latest",
});

const app = express();
const PORT = process.env.PORT || 3000;
const MONGO_URI =
  process.env.MONGO_URI || "mongodb://127.0.0.1:27017/twitter_scraper";

app.use(cors());
app.use(express.json());

// --- MongoDB Connection ---
mongoose
  .connect(MONGO_URI)
  .then(() => console.log("‚úÖ MongoDB connected successfully."))
  .catch((err) => console.error("‚ùå MongoDB connection error:", err));

// --- Mongoose Schema ---
const ArticleSchema = new mongoose.Schema(
  {
    title: { type: String, required: true },
    summary: { type: String },
    body: { type: String },
    teluguTitle: { type: String },
    teluguNews: { type: String },
    url: { type: String, required: true, unique: true },
    source: { type: String, required: true },
    isCreatedBy: { type: String, required: true, default: "manual" },
    publishedAt: { type: Date },
    media: [
      {
        mediaType: {
          type: String,
          enum: ["image", "video_post", "youtube_video"],
        },
        url: { type: String },
      },
    ],
  },
  { timestamps: true }
);

const Article = mongoose.model("Article", ArticleSchema);


// --- TELUGU SUMMARY HELPER FUNCTION ---
async function summarizeTeluguNews(teluguText) {
  if (!teluguText) return null;

  const prompt = `
‡∞Æ‡±Ä‡∞∞‡±Å ‡∞í‡∞ï ‡∞™‡±ç‡∞∞‡∞Æ‡±Å‡∞ñ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞æ ‡∞™‡∞§‡±ç‡∞∞‡∞ø‡∞ï‡∞≤‡±ã ‡∞Ö‡∞®‡±Å‡∞≠‡∞µ‡∞ú‡±ç‡∞û‡±Å‡∞≤‡±à‡∞® ‡∞∏‡∞Ç‡∞™‡∞æ‡∞¶‡∞ï‡±Å‡∞≤‡±Å. 
‡∞ï‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞æ ‡∞™‡∞æ‡∞†‡±ç‡∞Ø‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞∏‡±Å‡∞Æ‡∞æ‡∞∞‡±Å 80 ‡∞™‡∞¶‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Ç‡∞ó‡∞æ, ‡∞∏‡∞∞‡∞ø‡∞ó‡±ç‡∞ó‡∞æ, ‡∞™‡∞æ‡∞†‡∞ï‡±Å‡∞≤‡∞ï‡±Å ‡∞Ö‡∞®‡±Å‡∞µ‡±Å‡∞ó‡∞æ **‡∞∏‡∞æ‡∞∞‡∞æ‡∞Ç‡∞∂‡∞Ç** ‡∞∞‡∞æ‡∞Ø‡∞æ‡∞≤‡∞ø. 
‡∞™‡±ç‡∞∞‡∞ß‡∞æ‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á ‡∞â‡∞Ç‡∞ö‡∞æ‡∞≤‡∞ø, ‡∞Ö‡∞®‡∞µ‡∞∏‡∞∞ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞ø.

---
‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞æ ‡∞™‡∞æ‡∞†‡±ç‡∞Ø‡∞Ç:
${teluguText}
---

‡∞´‡∞≤‡∞ø‡∞§‡∞Ç: ‡∞ï‡±á‡∞µ‡∞≤‡∞Ç ‡∞∏‡∞æ‡∞∞‡∞æ‡∞Ç‡∞∂‡∞Ç ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á ‡∞á‡∞µ‡±ç‡∞µ‡∞æ‡∞≤‡∞ø, ‡∞Æ‡∞∞‡±á‡∞Æ‡±Ä ‡∞ï‡∞æ‡∞¶‡±Å.
`;

  try {
    console.log("üì∞ Calling Gemini API for Telugu summarization...");
    const result = await geminiModel.generateContent(prompt);
    const response = await result.response;
    let text = response.text().trim();

    // Just plain summary text (no JSON expected here)
    return text;
  } catch (error) {
    console.error("‚ùå Error summarizing Telugu news:", error);
    return null;
  }
}

// --- API: Summarize Telugu News ---
app.post("/summarize-telugu", async (req, res) => {
  const { text } = req.body;
  if (!text) {
    return res.status(400).json({ error: "Telugu text is required." });
  }

  try {
    const summary = await summarizeTeluguNews(text);
    if (!summary) {
      return res
        .status(500)
        .json({ error: "Failed to generate Telugu summary." });
    }

    res.json({
      originalLength: text.length,
      summaryLength: summary.length,
      summary,
    });
  } catch (err) {
    console.error("‚ùå Error in /summarize-telugu route:", err);
    res.status(500).json({ error: "Something went wrong.", details: err.message });
  }
});



// --- NEW: TELUGU TITLE GENERATION HELPER ---
async function generateTeluguTitle(teluguText) {
  if (!teluguText) return null;
  const prompt = `
‡∞Æ‡±Ä‡∞∞‡±Å ‡∞í‡∞ï ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞æ‡∞™‡∞§‡±ç‡∞∞‡∞ø‡∞ï ‡∞∏‡∞Ç‡∞™‡∞æ‡∞¶‡∞ï‡±Å‡∞≤‡±Å. ‡∞ï‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞æ ‡∞™‡∞æ‡∞†‡±ç‡∞Ø‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Ö‡∞§‡±ç‡∞Ø‡∞Ç‡∞§ ‡∞Ü‡∞ï‡∞∞‡±ç‡∞∑‡∞£‡±Ä‡∞Ø‡∞Æ‡±à‡∞®, ‡∞ï‡±ç‡∞≤‡±Å‡∞™‡±ç‡∞§‡∞Æ‡±à‡∞® ‡∞∂‡±Ä‡∞∞‡±ç‡∞∑‡∞ø‡∞ï (title)‡∞®‡±Å ‡∞∞‡∞æ‡∞Ø‡∞æ‡∞≤‡∞ø. ‡∞∂‡±Ä‡∞∞‡±ç‡∞∑‡∞ø‡∞ï 5-8 ‡∞™‡∞¶‡∞æ‡∞≤‡∞ï‡±Å ‡∞Æ‡∞ø‡∞Ç‡∞ö‡∞ï‡±Ç‡∞°‡∞¶‡±Å.

---
‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞æ ‡∞™‡∞æ‡∞†‡±ç‡∞Ø‡∞Ç:
${teluguText}
---

‡∞´‡∞≤‡∞ø‡∞§‡∞Ç: ‡∞ï‡±á‡∞µ‡∞≤‡∞Ç ‡∞∂‡±Ä‡∞∞‡±ç‡∞∑‡∞ø‡∞ï ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á ‡∞á‡∞µ‡±ç‡∞µ‡∞æ‡∞≤‡∞ø.`;
  try {
    console.log("üì∞ Calling Gemini API for Telugu title...");
    const result = await geminiModel.generateContent(prompt);
    return result.response.text().trim();
  } catch (error) {
    console.error("‚ùå Error generating Telugu title:", error);
    return null;
  }
}

// --- API: Create Article From Telugu Text ---
app.post("/create-news", async (req, res) => {
  const { text } = req.body;
  if (!text || text.trim().length < 20) {
    return res.status(400).json({ error: "A substantial amount of Telugu text is required." });
  }

  try {
    // 1. Generate all necessary components in parallel
    const [title, summary, imagePrompt] = await Promise.all([
      generateTeluguTitle(text),
      summarizeTeluguNews(text),
    ]);

    // Check if essential components were generated
    if (!title || !summary) {
      return res.status(500).json({ error: "Failed to generate essential content (title or summary)." });
    }
    
    // This is where you would use the image prompt to get an actual URL.
    // For now, we'll use a placeholder.
    const imageUrl = `https://cdn.pixabay.com/photo/2017/06/26/19/03/news-2444778_960_720.jpg`;

    // 2. Create the new article object
    const newArticle = new Article({
      title: title,
      summary: summary,
      body: text, // The original text is the body
      teluguTitle: title,
      teluguNews: summary,
      // Create a unique placeholder URL to satisfy the schema's unique constraint
      url: `manual://text-entry/${Date.now()}`,
      source: "manual_text_input", // Set a default source
      isCreatedBy: "manual",
      publishedAt: new Date(),
      media: [{
        mediaType: "image",
        url: imageUrl
      }],
    });

    // 3. Save the new article to the database
    await newArticle.save();

    res.status(201).json({
      message: "Successfully created and saved the new article.",
      article: newArticle,
    });

  } catch (err) {
    console.error("‚ùå Error in /create-from-text route:", err);
    res.status(500).json({ error: "An internal server error occurred.", details: err.message });
  }
});
// --- Utility ---
const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

// --- NEW: GEMINI HELPER FOR ENGLISH SUMMARIZATION ---
/**
 * Generates a summarized English title and summary from text using the Gemini API.
 * @param {string} englishText The text to be summarized.
 * @returns {Promise<{title: string, summary: string}|null>} A promise that resolves to an object with title and summary, or null on failure.
 */
async function summarizeTweetWithGemini(englishText) {
  if (!englishText || englishText.trim().length < 20) {
    console.warn("‚ö†Ô∏è Skipping Gemini call for short or empty text.");
    return null;
  }

  const prompt = `
You are an expert news editor. Your task is to summarize the following text, which is from a social media post, into a clean, professional news format.

Based on the text provided, generate:
1.  A concise and compelling news headline (title).
2.  A brief summary of the key information (summary) in about 40-50 words.

The output must be a single, clean JSON object with only two keys: "title" and "summary".

---
Source Text:
"${englishText}"
---
`;

  try {
    console.log("üì∞ Calling Gemini API for English summarization...");
    const result = await geminiModel.generateContent(prompt);
    const response = await result.response;
    let text = response.text();

    text = text
      .replace(/```json/g, "")
      .replace(/```/g, "")
      .trim();
    const parsedJson = JSON.parse(text);

    if (parsedJson.title && parsedJson.summary) {
      console.log("‚úÖ English summary generated successfully.");
      return parsedJson;
    } else {
      console.warn(
        "‚ö†Ô∏è Gemini response was missing title or summary.",
        parsedJson
      );
      return null;
    }
  } catch (error) {
    console.error("‚ùå Error calling Gemini API or parsing response:", error);
    return null;
  }
}

// --- GEMINI HELPER FUNCTION (WITH IMPROVED PROMPT) ---
/**
 * Generates a short Telugu news article from English text using the Gemini API.
 * @param {string} englishText The text to be converted into news.
 * @returns {Promise<{title: string, news: string}|null>} A promise that resolves to an object with title and news, or null on failure.
 */
async function generateTeluguNews(englishText) {
  if (!englishText) return null;

  // ‚≠ê --- MODIFIED PROMPT FOR BETTER, JOURNALISTIC STYLE --- ‚≠ê
  // This prompt now asks for a specific style ("in the style of a major newspaper")
  // and gives a more flexible word count ("around 65 words") to allow for more natural language.

  const prompt = `
You are no longer just an editor; you are a master Telugu journalist and storyteller for a top-tier publication like Eenadu. Your mission is not merely to translate but to **create** a complete, compelling, and publish-ready news article from the source text, embodying the highest standards of journalistic integrity and flair.

You will execute this mission by meticulously following a multi-layered protocol.

---
### 
  **Core Journalistic Principles (‡∞™‡±ç‡∞∞‡∞æ‡∞•‡∞Æ‡∞ø‡∞ï ‡∞∏‡±Ç‡∞§‡±ç‡∞∞‡∞æ‡∞≤‡±Å)**
This is your guiding philosophy.
* **Objectivity (‡∞µ‡∞∏‡±ç‡∞§‡±Å‡§®‡§ø‡§∑‡•ç‡§†‡∞§):** Report the facts without bias or personal opinion.
* **Clarity & Cohesion (‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞§ & ‡∞™‡±ä‡∞Ç‡∞¶‡∞ø‡∞ï):** Ensure the report flows logically and is easily understood by any reader.
* **Impact (‡∞™‡±ç‡∞∞‡∞≠‡∞æ‡∞µ‡∞Ç):** Always consider *why* this news matters and subtly convey its significance.

---
### 
  **Step 1: Content Analysis & Elaboration**
* **Categorize:** First, identify the primary category of the news (Political, Sports, Movie, Accident, Human Interest).
* **Elaborate (If Needed):** If the input text is brief (under ~15 words), invoke the **Elaboration Mandate**. Act as a true journalist: use your general knowledge to add necessary context, background, and plausible details (like key figures, location significance, or public sentiment) to build a complete 65-70 word report.

---
### 
  **Step 2: The Art of Writing (‡∞∞‡∞ö‡∞®‡∞æ ‡∞®‡±à‡∞™‡±Å‡∞£‡±ç‡∞Ø‡∞Ç)**
Based on the category, you will now craft the report.

#### 
  **A. Title Crafting Matrix (‡∞∂‡±Ä‡∞∞‡±ç‡∞∑‡∞ø‡∞ï ‡∞®‡±à‡∞™‡±Å‡∞£‡±ç‡∞Ø‡∞Ç):**
Choose the most fitting title style from below.
* **Direct & Factual:** For official/political news (e.g., "‡∞™‡±ã‡∞≤‡∞µ‡∞∞‡∞Ç‡∞™‡±à ‡∞Æ‡∞Ç‡∞§‡±ç‡∞∞‡∞ø ‡∞∏‡∞Æ‡±Ä‡∞ï‡±ç‡∞∑").
* **Intriguing & Evocative:** For sports/movies (e.g., "‡∞∞‡∞ø‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±Å‡∞≤ ‡∞µ‡±á‡∞ü‡∞≤‡±ã '‡∞∏‡∞≤‡∞æ‡∞∞‡±ç'").
* **Impact-Oriented:** For accidents/tragedies (e.g., "‡∞π‡±à‡∞µ‡±á‡∞™‡±à ‡∞™‡±Ü‡∞®‡±Å ‡∞µ‡∞ø‡∞∑‡∞æ‡∞¶‡∞Ç: ‡∞ê‡∞¶‡±Å‡∞ó‡±Å‡∞∞‡∞ø ‡∞Æ‡±É‡∞§‡∞ø").
* **Quote-Based:** If a powerful quote defines the story.

#### 
  **B. The Lede - Perfecting the First Sentence (‡∞Æ‡±ä‡∞¶‡∞ü‡∞ø ‡∞µ‡∞æ‡∞ï‡±ç‡∞Ø‡∞Ç):**
The opening sentence is critical. Choose the best approach.
* **Direct Lede:** For breaking news. State the most critical fact immediately (e.g., "‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±ç-‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞æ‡∞° ‡∞∞‡∞π‡∞¶‡∞æ‡∞∞‡∞ø‡∞™‡±à ‡∞ò‡±ã‡∞∞ ‡∞™‡±ç‡∞∞‡∞Æ‡∞æ‡∞¶‡∞Ç ‡∞ú‡∞∞‡∞ø‡∞ó‡∞ø‡∞Ç‡∞¶‡∞ø.").
* **Contextual Lede:** For complex stories. Start with the significance or background (e.g., "‡∞¨‡∞π‡±Å‡∞≥ ‡∞™‡±ç‡∞∞‡∞§‡±Ä‡∞ï‡±ç‡∞∑‡∞≤ ‡∞Æ‡∞ß‡±ç‡∞Ø '‡∞ï‡∞≤‡±ç‡∞ï‡∞ø' ‡∞ö‡∞ø‡∞§‡±ç‡∞∞‡∞Ç ‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞µ‡∞ø‡∞°‡±Å‡∞¶‡∞≤‡±à‡∞Ç‡∞¶‡∞ø.").
* **Creative Lede:** For human interest/entertainment. Use a compelling description (e.g., "‡∞ï‡±ç‡∞∞‡±Ä‡∞°‡∞æ‡∞≠‡∞ø‡∞Æ‡∞æ‡∞®‡±Å‡∞≤ ‡∞ï‡±á‡∞∞‡∞ø‡∞Ç‡∞§‡∞≤ ‡∞Æ‡∞ß‡±ç‡∞Ø ‡∞ü‡±Ä‡∞Æ‡∞ø‡∞Ç‡∞°‡∞ø‡∞Ø‡∞æ ‡∞∏‡∞ø‡∞∞‡±Ä‡∞∏‡±ç‚Äå‡∞®‡±Å ‡∞ï‡±à‡∞µ‡∞∏‡∞Ç ‡∞ö‡±á‡∞∏‡±Å‡∞ï‡±Å‡∞Ç‡∞¶‡∞ø.").

#### 
  **C. The Concluding Sentence (‡∞Æ‡±Å‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞µ‡∞æ‡∞ï‡±ç‡∞Ø‡∞Ç):**
End the report with a meaningful conclusion.
* **Next Steps:** State what is happening next (e.g., "...‡∞à ‡∞ò‡∞ü‡∞®‡∞™‡±à ‡∞™‡±ã‡∞≤‡±Ä‡∞∏‡±Å‡∞≤‡±Å ‡∞¶‡∞∞‡±ç‡∞Ø‡∞æ‡∞™‡±ç‡∞§‡±Å ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å.").
* **Broader Impact:** Mention the public reaction or significance (e.g., "...‡∞à ‡∞®‡∞ø‡∞∞‡±ç‡∞£‡∞Ø‡∞Ç‡∞™‡±à ‡∞∏‡∞∞‡±ç‡∞µ‡∞§‡±ç‡∞∞‡∞æ ‡∞π‡∞∞‡±ç‡∞∑‡∞Ç ‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞Æ‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø.").
* **Official Statement:** End with a relevant quote (e.g., "...‡∞Ö‡∞®‡∞ø ‡∞Æ‡∞Ç‡∞§‡±ç‡∞∞‡∞ø ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Ç ‡∞ö‡±á‡∞∂‡∞æ‡∞∞‡±Å.").

---
### 
  **Step 3: Final Output Format**
* **Dateline:** The news body MUST begin with a dateline (e.g., "‡∞Ö‡∞Æ‡∞∞‡∞æ‡∞µ‡∞§‡∞ø:"). If the location is unclear, infer a logical one ("‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±ç:", "‡∞®‡±ç‡∞Ø‡±Ç‡∞¢‡∞ø‡∞≤‡±ç‡∞≤‡±Ä:", "‡∞Æ‡±Å‡∞Ç‡∞¨‡±à:").
* **Length:** The body must be approximately 65-70 words.
* **JSON Structure:** The final output must be a single, clean JSON object with only two keys: "title" and "news". No extra text, notes, or markdown.

---
### 
  **Exemplars of Excellence**

#### 
  **Example 1: Political News (Contextual Lede, Direct Title)**
* **Input:** "CM Revanth Reddy launched the 'Praja Palana' scheme in Hyderabad."
* **Output:**
    {
        "title": "‡∞™‡±ç‡∞∞‡∞ú‡∞æ ‡∞™‡∞æ‡∞≤‡∞® ‡∞™‡∞•‡∞ï‡∞Ç ‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠‡∞Ç",
        "news": "‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±ç: ‡∞∞‡∞æ‡∞∑‡±ç‡∞ü‡±ç‡∞∞‡∞Ç‡∞≤‡±ã ‡∞Ö‡∞∞‡±ç‡∞π‡±Å‡∞≤‡±à‡∞® ‡∞™‡±ç‡∞∞‡∞§‡∞ø ‡∞í‡∞ï‡±ç‡∞ï‡∞∞‡∞ø‡∞ï‡±Ä ‡∞™‡±ç‡∞∞‡∞≠‡±Å‡∞§‡±ç‡∞µ ‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å ‡∞Ö‡∞Ç‡∞¶‡∞æ‡∞≤‡∞®‡±á ‡∞≤‡∞ï‡±ç‡∞∑‡±ç‡∞Ø‡∞Ç‡∞§‡±ã ‡∞Æ‡±Å‡∞ñ‡±ç‡∞Ø‡∞Æ‡∞Ç‡∞§‡±ç‡∞∞‡∞ø ‡∞∞‡±á‡∞µ‡∞Ç‡∞§‡±ç ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø '‡∞™‡±ç‡∞∞‡∞ú‡∞æ ‡∞™‡∞æ‡∞≤‡∞®' ‡∞ï‡∞æ‡∞∞‡±ç‡∞Ø‡∞ï‡±ç‡∞∞‡∞Æ‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠‡∞ø‡∞Ç‡∞ö‡∞æ‡∞∞‡±Å. ‡∞à ‡∞ï‡∞æ‡∞∞‡±ç‡∞Ø‡∞ï‡±ç‡∞∞‡∞Æ‡∞Ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞Ö‡∞ß‡∞ø‡∞ï‡∞æ‡∞∞‡±Å‡∞≤‡±Å ‡∞™‡±ç‡∞∞‡∞ú‡∞≤ ‡∞µ‡∞¶‡±ç‡∞¶‡∞ï‡±á ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞ø ‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å‡∞≤‡±Å ‡∞∏‡±ç‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞∏‡±ç‡∞§‡∞æ‡∞∞‡∞®‡∞ø ‡∞Ü‡∞Ø‡∞® ‡∞§‡±Ü‡∞≤‡∞ø‡∞™‡∞æ‡∞∞‡±Å. ‡∞à ‡∞®‡∞ø‡∞∞‡±ç‡∞£‡∞Ø‡∞Ç‡∞™‡±à ‡∞™‡±ç‡∞∞‡∞ú‡∞≤ ‡∞®‡±Å‡∞Ç‡∞ö‡∞ø ‡∞∏‡∞æ‡∞®‡±Å‡∞ï‡±Ç‡∞≤ ‡∞∏‡±ç‡∞™‡∞Ç‡∞¶‡∞® ‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞Æ‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø."
    }

#### 
  **Example 2: Movie News (Elaboration Mandate, Intriguing Title)**
* **Input:** "Kalki 2898 AD released."
* **Output:**
    {
        "title": "‡∞™‡±ç‡∞∞‡±á‡∞ï‡±ç‡∞∑‡∞ï‡±Å‡∞≤ ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å‡∞ï‡±Å '‡∞ï‡∞≤‡±ç‡∞ï‡∞ø'.. ‡∞•‡∞ø‡∞Ø‡±á‡∞ü‡∞∞‡±ç‡∞≤ ‡∞µ‡∞¶‡±ç‡∞¶ ‡∞™‡∞Ç‡∞°‡±Å‡∞ó ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç",
        "news": "‡∞π‡±à‡∞¶‡∞∞‡∞æ‡∞¨‡∞æ‡∞¶‡±ç: ‡∞¨‡∞π‡±Å‡∞≥ ‡∞™‡±ç‡∞∞‡∞§‡±Ä‡∞ï‡±ç‡∞∑‡∞≤ ‡∞Æ‡∞ß‡±ç‡∞Ø ‡∞™‡∞æ‡∞®‡±ç ‡∞á‡∞Ç‡∞°‡∞ø‡∞Ø‡∞æ ‡∞∏‡±ç‡∞ü‡∞æ‡∞∞‡±ç ‡∞™‡±ç‡∞∞‡∞≠‡∞æ‡∞∏‡±ç ‡∞®‡∞ü‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® '‡∞ï‡∞≤‡±ç‡∞ï‡∞ø 2898 ‡∞è‡∞°‡±Ä' ‡∞ö‡∞ø‡∞§‡±ç‡∞∞‡∞Ç ‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞™‡±ç‡∞∞‡∞™‡∞Ç‡∞ö‡∞µ‡±ç‡∞Ø‡∞æ‡∞™‡±ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞µ‡∞ø‡∞°‡±Å‡∞¶‡∞≤‡±à‡∞Ç‡∞¶‡∞ø. ‡∞®‡∞æ‡∞ó‡±ç ‡∞Ö‡∞∂‡±ç‡∞µ‡∞ø‡∞®‡±ç ‡∞¶‡∞∞‡±ç‡∞∂‡∞ï‡∞§‡±ç‡∞µ‡∞Ç‡∞≤‡±ã ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞´‡∞ø‡∞ï‡±ç‡∞∑‡∞®‡±ç ‡∞ï‡∞•‡∞æ‡∞Ç‡∞∂‡∞Ç‡∞§‡±ã ‡∞§‡±Ü‡∞∞‡∞ï‡±Ü‡∞ï‡±ç‡∞ï‡∞ø‡∞® ‡∞à ‡∞∏‡∞ø‡∞®‡∞ø‡∞Æ‡∞æ‡∞™‡±à ‡∞≠‡∞æ‡∞∞‡±Ä ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ‡∞≤‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Ø‡∞ø. ‡∞§‡±ä‡∞≤‡∞ø ‡∞™‡±ç‡∞∞‡∞¶‡∞∞‡±ç‡∞∂‡∞® ‡∞®‡±Å‡∞Ç‡∞ö‡±á ‡∞∏‡∞ø‡∞®‡∞ø‡∞Æ‡∞æ‡∞ï‡±Å ‡∞Ö‡∞¶‡±ç‡∞≠‡±Å‡∞§‡∞Æ‡±à‡∞® ‡∞∏‡±ç‡∞™‡∞Ç‡∞¶‡∞® ‡∞≤‡∞≠‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞°‡∞ü‡∞Ç‡∞§‡±ã ‡∞ö‡∞ø‡∞§‡±ç‡∞∞‡∞¨‡±É‡∞Ç‡∞¶‡∞Ç ‡∞π‡∞∞‡±ç‡∞∑‡∞Ç ‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞Ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø."
    }
---

Now, execute this protocol with the precision and flair of a world-class editor for the following text.
---
**English Text:**
${englishText}
---
`;
  try {
    console.log("üì∞ Calling Gemini API with improved prompt...");
    const result = await geminiModel.generateContent(prompt);
    const response = await result.response;
    let text = response.text();

    // Clean up the response to ensure it's valid JSON
    text = text
      .replace(/```json/g, "")
      .replace(/```/g, "")
      .trim();

    const parsedJson = JSON.parse(text);

    if (parsedJson.title && parsedJson.news) {
      console.log("‚úÖ Telugu news generated successfully.");
      return parsedJson;
    } else {
      console.warn("‚ö†Ô∏è Gemini response was missing title or news.", parsedJson);
      return null;
    }
  } catch (error) {
    console.error("‚ùå Error calling Gemini API or parsing response:", error);
    return null;
  }
}

// --- API Routes ---

// --- USER SCRAPE ROUTE (Checks all tweets, skips duplicates) ---
app.get("/scrape-user", async (req, res) => {
  const { username } = req.query;
  if (!username) {
    return res
      .status(400)
      .json({ error: "Username query parameter is required." });
  }

  try {
    const tweets = await scrapeUserTweets(username);

    const savedArticles = [];
    const skippedDuplicates = [];
    const skippedInvalid = [];

    for (const tweet of tweets) {
      if (!tweet.url) {
        console.warn("‚ö†Ô∏è Skipping tweet with no URL:", tweet);
        skippedInvalid.push(tweet);
        continue;
      }

      try {
        const exists = await Article.findOne({ url: tweet.url });

        // ‚≠ê Logic reverted: Now it skips the duplicate and continues the loop
        if (exists) {
          skippedDuplicates.push(tweet.url);
          continue; // Skip this tweet and move to the next one
        }

        const summarizedContent = await summarizeTweetWithGemini(tweet.text);
        const mediaData = tweet.image
          ? [{ mediaType: "image", url: tweet.image }]
          : [];

        const article = new Article({
          title: summarizedContent
            ? summarizedContent.title
            : tweet.text.slice(0, 100),
          summary: summarizedContent
            ? summarizedContent.summary
            : tweet.text.slice(0, 200),
          body: tweet.text,
          url: tweet.url,
          source: username,
          isCreatedBy: "twitter_scraper_user",
          publishedAt: tweet.publishedAt
            ? new Date(tweet.publishedAt)
            : new Date(),
          media: mediaData,
        });

        await article.save();
        savedArticles.push(article);
      } catch (err) {
        console.error(`‚ö†Ô∏è Error saving tweet ${tweet.id}:`, err.message);
      }
      await delay(200);
    }

    res.json({
      message: `Scraping for ${username} complete. All fetched tweets have been checked.`,
      savedCount: savedArticles.length,
      skippedDuplicatesCount: skippedDuplicates.length,
      skippedInvalidCount: skippedInvalid.length,
      savedArticles,
      skippedDuplicates,
    });
  } catch (err) {
    console.error(`‚ùå Failed to fetch tweets for ${username}:`, err);
    res.status(500).json({
      error: "Failed to fetch or process user tweets.",
      details: err.message,
    });
  }
});

// --- SINGLE POST SCRAPE ROUTE (As provided by you) ---
app.get("/scrape-post", async (req, res) => {
  const { url } = req.query;
  if (!url) {
    return res.status(400).json({ error: "URL query parameter is required." });
  }

  const twitterStatusRegex =
    /^https?:\/\/(twitter|x)\.com\/[a-zA-Z0-9_]+\/status\/[0-9]+/;
  if (!twitterStatusRegex.test(url)) {
    return res
      .status(400)
      .json({ error: "Invalid Twitter/X post URL provided." });
  }

  try {
    const existingArticle = await Article.findOne({ url });
    if (existingArticle) {
      return res.status(200).json({
        message: "Article already exists in the database.",
        isNew: false,
        article: existingArticle,
      });
    }

    // 1. Scrape the tweet
    const tweet = await scrapeSingleTweet(url);

    if (!tweet || !tweet.text) {
      return res.status(404).json({
        error:
          "Could not find or scrape the specified post, or post has no text.",
      });
    }

    // 2. Call Gemini API to generate Telugu news ‚≠êÔ∏è
    const teluguContent = await generateTeluguNews(tweet.text);

    const mediaData = tweet.image
      ? [{ mediaType: "image", url: tweet.image }]
      : [];
    const username =
      url.match(/(?:twitter|x)\.com\/(.*?)\/status/)[1] || "unknown";

    // 3. Create the new article with both English and Telugu content
    const newArticle = new Article({
      title: teluguContent ? teluguContent.title : tweet.text.slice(0, 100),
      summary: teluguContent ? teluguContent.news : tweet.text.slice(0, 200),
      // body: tweet.text,
      url: tweet.url.replace("x.com", "twitter.com"),
      source: username,
      isCreatedBy: "twitter_scraper",
      publishedAt: tweet.publishedAt ? new Date(tweet.publishedAt) : new Date(),
      media: mediaData,
      // Add telugu content if it was successfully generated
      teluguTitle: teluguContent ? teluguContent.title : null,
      teluguNews: teluguContent ? teluguContent.news : null,
    });

    // 4. Save to the database
    await newArticle.save();

    res.status(201).json({
      message:
        "Successfully scraped, generated Telugu news, and saved the new article.",
      isNew: true,
      article: newArticle,
    });
  } catch (err) {
    console.error(`‚ùå Failed to process post URL ${url}:`, err);
    res.status(500).json({
      error: "Failed to fetch or process the post.",
      details: err.message,
    });
  }
});

app.get("/", (req, res) => res.send("Twitter scraper is running ‚úÖ"));

app.listen(PORT, () =>
  console.log(`üöÄ Server running on http://localhost:${PORT}`)
);
